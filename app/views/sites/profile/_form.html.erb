<%= render partial: '/sites/profile/confirm_rescope' %>

<%= simple_form_for @site_profile, html: { class: 'profile-form' } do |f| %>
    <%= f.error_notification %>

    <% if f.error_notification %>
        <div>
            <ul>
                <% @site.profile.errors.messages.each do |attribute, messages| %>
                    <li>
                        <%= link_to attribute.to_s.humanize,
                                    "#site_profile_#{attribute}",
                                    class: 'scroll' %>
                        <% if messages.size == 1 %>
                            <%= messages.first %>
                        <% else %>
                            <ul class="list-unstyled">
                                <% messages.each do |message| %>
                                    <li>
                                        <span class="text text-muted">
                                            <%= message %>
                                        </span>
                                    </li>
                                <% end %>
                            </ul>
                        <% end %>
                    </li>
                <% end %>
            </ul>
        </div>
    <% end %>

    <div id="scans">
        <fieldset>
            <h2 id="scans-h">
                Scans
            </h2>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :max_parallel_scans,
                                label: 'Maximum parallel scans'
                    %>
                </div>
                <div class="col-md-6 input-help">
                    <%= messages_for( :max_parallel_scans ) %>

                    <p class="text text-muted alert alert-warning">
                        It is recommended that the value be set to <kbd>1</kbd>,
                        in order to keep server stress low and prevent sessions
                        of authenticated scans from interfering with each other.
                    </p>
                </div>
            </div>
        </fieldset>
    </div>

    <hr/>

  <div class="mt-3" id="audit">
    <fieldset>
      <h2 id="audit-h">
        Audit
        <span class="text-muted fs-6">How shall the web application be audited?</span>
      </h2>

      <div class="row">
        <div class="col-md-6">
          <%= f.input :audit_mode,
                      label: 'Mode',
                      default: SCNR::Engine::Options.audit.mode,
                      collection: SCNR::Engine::Options.audit.class::MODES
          %>
        </div>
        <div class="col-md-6 input-help">
          <%= messages_for( :scan_mode ) %>

          <p class="text text-muted alert alert-info">
            Different web applications may require different types of audit modes to yield best results. <br/>
            It's a good idea to initially experiment and adjust accordingly.
          </p>
        </div>
      </div>
    </fieldset>
  </div>

  <hr/>

  <div class="mt-3" id="platforms">
        <fieldset>
            <h2 id="platforms-h">
                Software stack
                <span class="text-muted fs-6">What platforms does the application use?</span>
            </h2>

            <div class="text text-muted mb-2">
                Providing as much platform information as possible will result
                in a much faster and focused scan.
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            Popular configurations
                        </div>

                        <div class="card-body">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-light platforms-preset">
                                    Linux, Apache, MySQL, PHP
                                </button>
                                <button type="button"  class="btn btn-light platforms-preset">
                                    Linux, Nginx, Postgresql, Ruby, Ruby on Rails
                                </button>
                                <button type="button"  class="btn btn-light platforms-preset">
                                    Linux, TomCat, Generic SQL family, Java
                                </button>
                                <button type="button"  class="btn btn-light platforms-preset">
                                    MS Windows, IIS, MSSQL, ASP, ASP.NET
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="platforms-list" class="row mt-3">
                <% [:os, :servers, :db, :languages, :frameworks].each_with_index do |type, i| %>
                    <div class="col-md-2">
                        <div class="card bg-light">
                            <div class="card-header">
                                <%= platform_type_fullname( type ) %>
                            </div>
                            <div class="card-body">
                                <%= f.input :platforms, collection: valid_platforms( type ),
                                            label:  false,
                                            as: :check_boxes,
                                            label_method: lambda { |p| platform_fullname( p ) }
                                %>
                            </div>
                        </div>
                    </div>
                <% end %>
            </div>

            <%= advanced id: 'platforms' do %>
                <div class="row">
                    <div class="col-md-6">
                        <%= f.input :no_fingerprinting,
                                    label: 'Disable fingerprinting'
                        %>
                    </div>
                    <div class="col-md-6 checkbox-help">
                        <%= messages_for( :no_fingerprinting ) %>
                    </div>
                </div>
            <% end %>

        </fieldset>
    </div>

    <hr/>

    <div class="mt-3" id="scope">
        <fieldset>
            <h2 id="scope-h">
                Scope
                <span class="text-muted fs-6">Are there any special considerations regarding the scope of the scan?</span>
            </h2>

            <div class="text text-muted">
                If there are dangerous, redundant or generally unwanted resources,
                you can configure the site-wide scan scope to limit their processing
                or exclude them altogether.
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :scope_exclude_file_extensions,
                                label: 'Exclude file extensions',
                                as: :text,
                                placeholder: 'Process all resources identically',
                                input_html: {
                                        value: @site.profile.scope_exclude_file_extensions.join( ' ' )
                                } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :scope_exclude_file_extensions ) %>
                    <p class="text text-muted">Separate extensions with space.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :scope_template_path_patterns,
                                as: :text,
                                label: 'Path template patterns',
                                placeholder: 'Process all resources identically',
                                input_html: {
                                        value: @site.profile.scope_template_path_patterns.join( "\n" )
                                } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :scope_template_path_patterns ) %>
                    <p class="text text-muted">Input each rule in its own line.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :scope_exclude_path_patterns,
                                as: :text,
                                label: 'Path exclusion patterns',
                                placeholder: 'Do not exclude any resources',
                                input_html: { value: @site.profile.scope_exclude_path_patterns.join( "\n" ) } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :scope_exclude_path_patterns ) %>
                    <p class="text text-muted">Input each rule in its own line.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :scope_auto_redundant_paths,
                                as: :text,
                                label: 'Parameter redundancy limit',
                                placeholder: 'Infinite' %>
                </div>
                <div class="col-md-6 input-help">
                    <%= messages_for( :scope_auto_redundant_paths ) %>
                </div>
            </div>

            <% if @site.https? %>
            <div class="row">
                <div class="col-md-6">
                    <%= f.input :scope_https_only,
                                label: 'Only follow HTTPS URLs' %>
                </div>
            </div>
            <% end %>

            <%= advanced id: 'scope' do %>
                <div class="row">
                    <div class="col-md-6">
                        <%= f.input :scope_extend_paths,
                                    as: :text,
                                    label: 'Extend paths',
                                    placeholder: 'Only use paths discovered by the crawl',
                                    input_html: { value: @site.profile.scope_extend_paths.join( "\n" ) } %>
                    </div>
                    <div class="col-md-6 textarea-help">
                        <%= messages_for( :scope_extend_paths ) %>
                        <p class="text text-muted">Input each path in its own line.</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <%= f.input :scope_exclude_content_patterns,
                                    as: :text,
                                    label: 'Content exclusion patterns',
                                    placeholder: 'Include all pages',
                                    input_html: {
                                            value: @site.profile.scope_exclude_content_patterns.join( "\n" )
                                    } %>
                    </div>
                    <div class="col-md-6 textarea-help">
                        <%= messages_for( :scope_exclude_content_patterns ) %>
                        <p class="text text-muted">Input each rule in its own line.</p>
                    </div>
                </div>
            <% end %>
        </fieldset>
    </div>

    <hr/>

    <div class="mt-3" id="inputs">
        <fieldset>
            <h2 id="inputs-h">
                Inputs
                <span class="text-muted fs-6">Does the application require special input handling?</span>
            </h2>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :audit_link_templates,
                                as: :text,
                                label: 'Custom inputs',
                                placeholder: 'Custom inputs not necessary',
                                input_html: { value: @site.profile.audit_link_templates.join( "\n" ) } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :audit_link_templates ) %>
                    <p class="text text-muted">
                        For example, to extract the <code>input1</code> and <code>input2</code> inputs from
                        <code>http://test.com/input1/value1/input2/value2</code> use
                        <code>/input1\/(?&lt;input1&gt;\w+)\/input2\/(?&lt;input2&gt;\w+)/</code>.
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :scope_url_rewrites,
                                as: :text,
                                label: 'URL rewrite rules',
                                placeholder: 'No URL rewriting',
                                input_html: {
                                        value: @site.profile.scope_url_rewrites.
                                                       map { |k, v| "#{k}:#{v}" }.join( "\n" )
                                } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :scope_url_rewrites ) %>
                    <p class="text text-muted">
                        Rules take the format of <kbd>pattern:substitution</kbd>,
                        input each rule in its own line.<br/>

                        For example, to convert <code>http://test.com/articles/some-stuff/23</code> to
                        <code>http://test.com/articles.php?id=23</code> use
                        <code>/articles\/[\w-]+\/(\d+)/:articles.php?id=\1</code>.
                    </p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :input_values,
                                as: :text,
                                label: 'Fill-in values',
                                placeholder: 'No need for special values',
                                input_html: {
                                        value: @site.profile.input_values.
                                                map { |k, v| "#{k}=#{v}" }.join( "\n" )
                                } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :input_values ) %>
                    <p class="text text-muted">
                        Rules take the format of <kbd>pattern=value</kbd>,
                        input each rule in its own line &mdash; <kbd>pattern</kbd>
                        will be matched against input names.

                        <br/>

                        Rules will be matched in the given order.
                    </p>
                </div>
            </div>
        </fieldset>
    </div>

    <hr/>

    <div class="mt-3" id="http">
        <fieldset>
            <h2 id="http-h">
                HTTP
                <span class="text-muted fs-6">Is there any special HTTP configuration required?</span>
            </h2>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :http_authentication_username,
                                placeholder: 'No authentication',
                                label: 'Username' %>
                </div>
                <div class="col-md-6 input-help">
                    <%= messages_for( :http_authentication_username ) %>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <%= f.input :http_authentication_password, as: :string,
                                placeholder: 'No authentication',
                                label: 'Password' %>
                </div>
                <div class="col-md-6 input-help">
                    <%= messages_for( :http_authentication_password ) %>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :http_cookies,
                                as: :text,
                                label: 'Cookies',
                                placeholder: 'No need for special cookies',
                                input_html: {
                                        value: @site.profile.http_cookies.
                                                       map { |k, v| "#{k}=#{v}" }.join( "\n" )
                                } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :http_cookies ) %>

                    <p class="text text-muted">
                        Cookies take the format of <kbd>name=value</kbd>,
                        input each cookie in its own line.
                    </p>

                    <p class="alert alert-warning">
                        Please do not use this option for authentication purposes,
                        instead configure a <%= link_to 'user role', site_roles_path( @site ) %>.
                    </p>

                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :http_request_headers,
                                as: :text,
                                label: 'Headers',
                                placeholder: 'No need for special headers',
                                input_html: {
                                        value: @site.profile.http_request_headers.
                                                       map { |k, v| "#{k}=#{v}" }.join( "\n" )
                                } %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :http_request_headers ) %>
                    <p class="text text-muted">
                        Headers take the format of <kbd>name=value</kbd>,
                        input each header in its own line.
                    </p>
                </div>
            </div>

            <%= advanced id: 'http' do %>
                <div class="row">
                    <div class="col-md-6">
                        <%= f.input :http_request_concurrency,
                                    label: 'Request concurrency',
                                    placeholder: SCNR::Engine::Options.http.request_concurrency.to_s
                        %>
                    </div>
                    <div class="col-md-6 input-help">
                        <%= messages_for( :http_request_concurrency ) %>
                    </div>
                </div>
            <% end %>

        </fieldset>
    </div>

    <hr/>

    <div class="mt-3" id="browser">
        <fieldset>
            <h2 id="browser-h">
                Browser
                <span class="text-muted fs-6">Browser-related options.</span>
            </h2>

            <div class="row">
                <div class="col-md-6">
                    <%= f.input :dom_wait_for_elements,
                                as: :text,
                                label: 'Wait for elements to appear',
                                placeholder: 'No need for special rules regarding the ready-state of pages',
                                input_html: {
                                        value: @site.profile.dom_wait_for_elements.
                                                       map { |k, v| "#{k}=#{v}" }.join( "\n" )
                                }
                    %>
                </div>
                <div class="col-md-6 textarea-help">
                    <%= messages_for( :dom_wait_for_elements ) %>
                    <div class="text text-muted">
                        <p>
                            Rules take the format of <kbd>pattern=css</kbd>,
                            input each rule in its own line.
                        </p>

                        <p>
                            For example, to wait for an element with an ID attribute
                            of <code>myElement</code> to appear when visiting a page
                            whose URL includes the string <code>withElement</code>
                            (like: <code>http://test.com/blah#withElement</code>)
                            you can use: <code>withElement=#myElement</code>
                        </p>

                        <p>
                            Sometimes it is necessary to wait for an element for a
                            page whose URL does not include a string; this is common
                            for client-side MVC frameworks when URLs include no
                            route information in the fragment section.
                        </p>

                        <p>
                            In this case, in order to wait for an element with an ID
                            attribute of <code>myElement</code> when the URL has no
                            hash (<code>#</code>) part, use: <code>^((?!#).)*$=#myElement</code>
                        </p>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>

    <div class="d-none">
        <%= f.input :apply, as: :fake %>
    </div>

    <div class="form-actions">
        <%= f.button :submit, class: 'd-none' %>
    </div>
<% end %>
